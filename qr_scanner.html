<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Сканер</title>
<style>
    body, html {
        margin: 0;
        padding: 0;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
        background-color: #000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: white;
    }
    #reader {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    #reader video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    #status-message {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
        z-index: 100;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 1.2em;
        padding: 20px;
        box-sizing: border-box;
    }
    #result-text {
        margin-bottom: 20px;
        word-break: break-all; /* Для перенесення довгих рядків */
    }
    #copy-button {
        padding: 10px 20px;
        font-size: 1em;
        cursor: pointer;
        border-radius: 8px;
        border: none;
        background-color: #007bff;
        color: white;
        transition: background-color 0.2s;
    }
    #copy-button:active {
        background-color: #0056b3;
    }
</style>
</head>
<body>

<div id="reader"></div>
<div id="status-message">
    <div id="result-text"></div>
    <button id="copy-button">Копіювати</button>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    try {
        let scanSuccessful = false;
        const html5QrCode = new Html5Qrcode("reader");
        const readerDiv = document.getElementById('reader');
        const statusMessageDiv = document.getElementById('status-message');
        const resultTextDiv = document.getElementById('result-text');
        const copyButton = document.getElementById('copy-button');

        function onScanSuccess(decodedText, decodedResult) {
            if (scanSuccessful) return;
            scanSuccessful = true;

            html5QrCode.stop().catch(err => console.error("Помилка зупинки сканера.", err));

            if (navigator.vibrate) {
                navigator.vibrate(100);
            }

            readerDiv.style.display = 'none';
            statusMessageDiv.style.display = 'flex';
            resultTextDiv.innerText = `Відскановано: ${decodedText}`;

            copyButton.addEventListener('click', () => {
                navigator.clipboard.writeText(decodedText).then(() => {
                    copyButton.innerText = 'Скопійовано!';
                    setTimeout(() => {
                        copyButton.innerText = 'Копіювати';
                    }, 1500);
                }).catch(err => {
                    console.error('Не вдалося скопіювати текст: ', err);
                    resultTextDiv.innerText += "\nПомилка копіювання.";
                });
            });
        }

        const formatsToSupport = [
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.UPC_A,
            Html5QrcodeSupportedFormats.UPC_E,
            Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.ITF,
            Html5QrcodeSupportedFormats.QR_CODE
        ];
        
        const config = {
            fps: 10,
            qrbox: (viewfinderWidth, viewfinderHeight) => {
                let width = Math.floor(viewfinderWidth * 0.85);
                if (width > 300) width = 300;
                return {
                    width: width,
                    height: Math.floor(width * 0.7)
                };
            },
            formatsToSupport: formatsToSupport,
            experimentalFeatures: {
                useBarCodeDetectorIfSupported: true
            }
        };

        html5QrCode.start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            (errorMessage) => { /* Ігнорувати помилки сканування */ }
        ).catch(err => {
            document.body.innerHTML = `<div style="color:white; text-align:center; padding: 20px;">Помилка доступу до камери. Будь ласка, надайте дозвіл.</div>`;
            console.error("Не вдалося запустити камеру.", err);
        });

    } catch (e) {
        document.body.innerHTML = `<div style="color:white; text-align:center; padding: 20px;">Сталася критична помилка: ${e.message}</div>`;
        console.error("Глобальна помилка скрипта:", e);
    }
});
</script>
</body>
</html>
