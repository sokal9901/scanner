<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Сканер Штрих-коду</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Повертаємося до QuaggaJS, оскільки він більш стабільний -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; height: 100%; width: 100%; background-color: #000; }
        #scanner-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
        #scanner-container video, #scanner-container canvas { width: 100%; height: 100%; object-fit: cover; }
        /* Canvas потрібен для QuaggaJS, але ми його не показуємо */
        .drawingBuffer { display: none; }
        #close-btn { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; background-color: rgba(0,0,0,0.5); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; cursor: pointer; z-index: 20; }
        #status-message { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 10px; z-index: 20; }
    </style>
</head>
<body>
    <div id="scanner-container"></div>
    <div id="close-btn" onclick="closeScanner()">×</div>
    <div id="status-message">Запуск камери...</div>

    <script>
        const statusMessage = document.getElementById('status-message');

        function closeScanner() {
            try {
                Quagga.stop();
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.close();
                } else {
                    window.close();
                }
            } catch (e) {
                console.error("Failed to close or stop scanner:", e);
            }
        }

        function startScanner() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'),
                    // --- ВИПРАВЛЕННЯ ТУТ ---
                    // Максимально спрощені вимоги до камери для кращої сумісності
                    constraints: {
                        facingMode: "environment" // Тільки просимо задню камеру
                    },
                },
                decoder: {
                    readers: ["ean_reader", "upc_reader", "code_128_reader"]
                },
                locate: true,
                locator: {
                    patchSize: "medium",
                    halfSample: true,
                },
                numOfWorkers: navigator.hardwareConcurrency || 4,
            }, function(err) {
                if (err) {
                    console.error("Quagga initialization failed:", err);
                    statusMessage.textContent = 'Помилка запуску камери.';
                    return;
                }
                console.log("Initialization finished. Ready to start");
                Quagga.start();
                statusMessage.textContent = 'Наведіть камеру на штрих-код';
            });

            Quagga.onDetected(function(result) {
                const code = result.codeResult.code;
                console.log("Barcode detected and processed", code);
                statusMessage.textContent = `Знайдено: ${code}`;
                
                // Зупиняємо сканування
                Quagga.stop();
                
                // Надсилаємо дані та закриваємо
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.sendData(code);
                    setTimeout(closeScanner, 100);
                } else {
                    alert(`Штрих-код: ${code}`);
                }
            });
        }

        window.addEventListener('load', startScanner);
    </script>
</body>
</html>

